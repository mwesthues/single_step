---
title: "Evaluation of LOOCV predictive abilities"
output: 
  html_document:
    toc: true
    toc_float: true
    smooth_scroll: true
    toc_depth: 3
    number_sections: true
    theme: lumen
    highlight: tango
    fig_width: 8
    fig_height: 5
---

# Data preparation
Load packages
```{r message = FALSE}
if (!require("pacman")) install.packages("pacman")
pacman::p_load("data.table", "ggplot2", "ggthemes", "dplyr", "forcats", 
               "viridis", "tidyr", "gridExtra", "modelr", "MASS")
```

Set knitr options
```{r message = FALSE}
knitr::opts_knit$set(root.dir = "~/gamazon/")
```

Load log files and data
```{r Load_Data, cache = TRUE}
run_log <- fread("./data/derived/pred_log.txt")

# LOOCV 
loocv_nms <- run_log[CV == "LOOCV", Job_ID, ]
loocv <- lapply(seq_along(loocv_nms), FUN = function(i) {
  readRDS(paste0("./data/derived/predictions/", loocv_nms[i], ".RDS"))
})
loocv <- rbindlist(loocv)
```



Change trait names and compute residuals.
```{r Rename_Traits, cache = TRUE}
loocv_clean <- loocv %>%
  mutate(Trait = fct_recode(Trait, 
                            "FAT" = "FETT",
                            "PRO" = "RPR",
                            "DMY" = "GTM",
                            "DMC" = "GTS"),
         Trait = fct_relevel(Trait, c("DMY", "DMC", "ADF", "FAT", "PRO", "STA",
                                      "XZ")),
         
         Dent_NA_Fraction = as.factor(as.character(Dent_NA_Fraction)),
         Flint_NA_Fraction = as.factor(as.character(Flint_NA_Fraction)),
         Residuals = y - yhat
  )
```

## Predictive ability for non-imputed data
Peak at predictive abilities based on non-imputed predictor information and rank
the results by their predictive ability.
```{r Non_Imputed_Pred_Ability, cache = TRUE}
loocv_clean %>%
  filter(Dent_NA_Fraction == 0, Flint_NA_Fraction == 0) %>%
  mutate(Predictor = as.factor(Predictor)) %>%
  droplevels() %>%
  group_by(Predictor, Trait) %>%
  summarize(Pred_Ability = cor(y, yhat)) %>%
  arrange(desc(Pred_Ability))
```


# Plots
## Complete data (no ssBLUP)
### Predicted vs. residuals
```{r Complete_Data_Residuals, cache = TRUE}
full_pred_resid <- loocv_clean %>%
  filter(Dent_NA_Fraction == 0, Flint_NA_Fraction == 0) %>%
  group_by(Predictor) %>%
  do(plot = ggplot(., aes(x = yhat, y = Residuals)) +
       geom_point(size = 0.5) +
       geom_ref_line(h = 0) +
       facet_wrap(~ Trait, nrow = 2, scales = "free") +
       theme(axis.text.x = element_text(angle = 60, hjust = 1, vjust = 1)) +
       xlab("Predicted") +
       ylab("Residuals") +
       ggtitle(.$Predictor))
invisible(lapply(full_pred_resid$plot, FUN = print))
```

### Predicted vs. Observed
```{r Complete_Data_y_yHat, cache = TRUE}
full_y_yhat <- loocv_clean %>%
  filter(Dent_NA_Fraction == 0, Flint_NA_Fraction == 0) %>%
  group_by(Predictor) %>%
  do(plot = ggplot(., aes(x = y, y = yhat)) +
       geom_point(size = 0.5) +
       geom_abline(slope = 1, linetype = "dashed", color = "blue") +
       facet_wrap(~ Trait, nrow = 2, scales = "free") +
       theme(axis.text.x = element_text(angle = 60, hjust = 1, vjust = 1)) +
       xlab("Predicted") +
       ylab("Residuals") +
       ggtitle(.$Predictor))
invisible(lapply(full_y_yhat$plot, FUN = print))
```


## Imputed data
### Predicted vs. residuals
Generate residual plots for each trait and each combination of missing values 
in Dent (rows) and Flint (columns) parents.
```{r Imputed_Residual, cache = TRUE}
resid_plots <- loocv_clean %>%
  filter(Predictor == "mrna") %>%
  group_by(Trait) %>%
  do(plot = ggplot(., aes(x = yhat, y = Residuals)) +
            geom_point(size = 0.5) +
            geom_ref_line(h = 0) +
            facet_grid(Dent_NA_Fraction ~ Flint_NA_Fraction) +
            theme_light() +
            theme(axis.text.x = element_text(angle = 60, 
                                             hjust = 1, vjust = 1)) +
            xlab("Predicted") +
            ylab("Residuals") +
            ggtitle(.$Trait))
invisible(lapply(resid_plots$plot, print))
```


### Predicted vs. observed
Likewise, compare observed with predicted values for combinations that were used
in the previous plot.
```{r Imputed_y_yHat, cache = TRUE}
y_yhat_plots <- loocv_clean %>%
  filter(Predictor == "mrna") %>%
  group_by(Trait) %>%
  do(plot = ggplot(., aes(x = y, y = yhat)) +
            geom_point(size = 0.5) +
            geom_abline(slope = 1, linetype = "dashed", color = "blue") +
            facet_grid(Dent_NA_Fraction ~ Flint_NA_Fraction) +
            theme(axis.text.x = element_text(angle = 60,
                                             hjust = 1, vjust = 1)) +
            xlab("Observed") +
            ylab("Predicted") +
            ggtitle(.$Trait))
invisible(lapply(y_yhat_plots$plot, print))
```



## LOOCV predictive ability (DMY)
### mrna
```{r DMY, cache = TRUE}
dmy <- loocv_clean %>%
  mutate(Dent_NA_Fraction = as.numeric(as.character(Dent_NA_Fraction)),
         Flint_NA_Fraction = as.numeric(as.character(Flint_NA_Fraction))) %>%
  filter(Trait == "DMY", Predictor == "mrna") %>%
  droplevels() %>%
  unite(NA_Fraction, Dent_NA_Fraction, Flint_NA_Fraction, sep = "_") %>%
  group_by(Predictor, Trait, NA_Fraction) %>%
  summarize(Pred_Ability = cor(y, yhat)) %>%
  ungroup() %>%
  arrange(desc(Pred_Ability)) %>%
  separate(NA_Fraction,
           into = c("Dent_NA_Fraction", "Flint_NA_Fraction"), 
           sep = "_") %>%
  mutate(Dent_NA_Fraction = as.numeric(Dent_NA_Fraction),
         Flint_NA_Fraction = as.numeric(Flint_NA_Fraction)) %>%
  rowwise() %>%
  mutate(Avg_NA = mean(c(Dent_NA_Fraction, Flint_NA_Fraction)))
```

### Average r as a function of global missingness and missingness in Flint
```{r DMY_Global_NA_Flint_NA, cache = TRUE}
dmy %>%
  mutate(Flint_NA_Fraction = as.factor(as.character(Flint_NA_Fraction))) %>%
  mutate(Flint_NA_Fraction = fct_relevel(Flint_NA_Fraction, 
                                         "0", "0.1", "0.2", "0.3", "0.4",
                                         "0.5", "0.6")) %>%
  arrange(desc(Avg_NA)) %>%
  ggplot(aes(x = Avg_NA, y = Pred_Ability, color = Flint_NA_Fraction)) +
  geom_point(size = 2) +
  geom_line() +
  geom_smooth(method = "rlm", aes(group = 1)) +
  theme_light() +
  ylab("r")
```

### Average r as a function of missingness in Dent and missingness in Flint
```{r DMY_Dent_NA_Flint_NA, cache = TRUE}
dmy %>%
  mutate(Flint_NA_Fraction = as.factor(as.character(Flint_NA_Fraction))) %>%
  mutate(Flint_NA_Fraction = fct_relevel(Flint_NA_Fraction, 
                                         "0", "0.1", "0.2", "0.3", "0.4",
                                         "0.5", "0.6")) %>%
  arrange(desc(Dent_NA_Fraction)) %>%
  ggplot(aes(x = Dent_NA_Fraction, y = Pred_Ability, 
             color = Flint_NA_Fraction)) +
  geom_point(size = 2) +
  geom_line() +
  geom_smooth(method = "rlm", aes(group = 1)) +
  theme_light() +
  ylab("r")
```


### Predictive ability as a function of missingness in Dent and missingness in 
### Flint for all traits
```{r All_Traits_Dent_NA_Flint_NA, cache = TRUE} 
loocv_clean %>%
  filter(Dent_NA_Fraction != 0, Flint_NA_Fraction != 0) %>%
  unite(NA_Fraction, Dent_NA_Fraction, Flint_NA_Fraction, sep = "_") %>%
  group_by(Trait, NA_Fraction) %>%
  summarize(Pred_Ability = cor(y, yhat)) %>%
  ungroup() %>%
  separate(NA_Fraction, into = c("Dent_NA_Fraction",
                                 "Flint_NA_Fraction"), sep = "_") %>%
  mutate(Dent_NA_Fraction = as.numeric(Dent_NA_Fraction)) %>%
  ggplot(aes(x = Dent_NA_Fraction, y = Pred_Ability, 
             color = Flint_NA_Fraction)) +
  geom_line() +
  facet_wrap(~ Trait, scales = "free_x") +
  theme_light() +
  scale_color_viridis(discrete = TRUE) +
  theme(legend.position = "top") +
  ylab("r")
```