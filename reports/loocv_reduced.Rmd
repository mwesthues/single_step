# LOOCV-Prediction
```{r setup-loocv, message = FALSE, echo = FALSE}
if (!require("pacman")) install.packages("pacman")
pacman::p_load("tidyverse", "data.table", "dtplyr", "ggthemes", "viridis",
               "stringr", "forcats")

knitr::knit_hooks$set(inline = function(x) {
  prettyNum(x, big.mark = ",", digits = 2)
})
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
knitr::opts_chunk$set(fig.width = 8, fig.height = 6,
                      warning = FALSE, echo = FALSE)
```

```{r Load-LOOCV-Data, cache = TRUE}
log_file <- fread("./data/derived/pred_log.txt")

pred_df <- log_file %>%
  .$Job_ID %>%
  as.list() %>%
  map(~readRDS(paste0("./data/derived/predictions/", ., ".RDS"))) %>%
  bind_rows(.id = "id") %>%
  left_join(y = log_file %>% select(Job_ID, Pred1, Pred2, Pred3, Trait, Iter),
            by = "Job_ID") %>%
  filter(Iter == 30000) %>%
  unite(col = Predictor, Pred1, Pred2, Pred3, sep = "-") %>%
  mutate(Trait = fct_recode(Trait,
    "DMY" = "GTM",
    "DMC" = "GTS",
    "FAT" = "FETT",
    "PRO" = "RPR",
    "SUG" = "XZ"
  )) %>%
  mutate(Trait = fct_relevel(Trait,
                             "DMY", "DMC", "ADF", "FAT", "PRO", "STA", "SUG"),
         Predictor = as.factor(Predictor)) %>%
  select(-Job_ID, -Iter)


# Update the variable 'Trait' for subsequent joins with 'pred_df'.
log_file <- log_file %>%
  filter(Iter == 30000) %>%
  mutate(Trait = fct_recode(Trait,
    "DMY" = "GTM",
    "DMC" = "GTS",
    "FAT" = "FETT",
    "PRO" = "RPR",
    "SUG" = "XZ"
  )) %>%
  mutate(Trait = fct_relevel(Trait,
                             "DMY", "DMC", "ADF", "FAT", "PRO",
                             "STA", "SUG")) %>%
  unite(col = Predictor, Pred1, Pred2, Pred3, sep = "-")
```


Compute the average standard deviation for each combination of predictors and 
traits -> http://stats.stackexchange.com/a/26647
```{r Coefficient-of-Variation, cache = TRUE}
coefficient_of_variation <- function(x, y) {
  sqrt(mean(x)) / mean(y)
}
cv_df <- pred_df %>%
  split(list(.$Trait, .$Predictor)) %>%
  map(~coefficient_of_variation(x = .$var_yhat, y = .$yhat)) %>%
  stack() %>%
  separate(col = ind, into = c("Trait", "Predictor"), sep = "[.]") %>%
  rename(CV = values) %>%
  tbl_dt() %>%
  mutate(Predictor = as.factor(Predictor),
         Trait = as.factor(Trait))
```



Combine predictive abilities and coefficients of variation for all predictor
and trait combinations for plotting.
```{r Organize-Data, cache = TRUE}
overview_df <- pred_df %>%
  group_by(Predictor, Trait) %>%
  summarize(r = cor(y, yhat)) %>%
  ungroup() %>%
  as.data.frame() %>%
  left_join(y = cv_df, by = c("Predictor", "Trait")) %>%
  as_tibble() %>%
  mutate(Predictor = as.factor(Predictor),
         Predictor = forcats::fct_reorder(Predictor, CV),
         Trait = fct_relevel(Trait,
                             "DMY", "DMC", "ADF", "FAT", "PRO",
                             "STA", "SUG"),
         Group = ifelse(Predictor %in% c("snp42-none-none",
                                         "ped42-none-none",
                                         "mrna42-none-none"),
                        yes = "Reduced", no = "Full")
  ) %>%
  mutate(Group = as.factor(Group))

# Specify a unified predictor order.
pred_order <- c("ped42-none-none", "snp42-none-none", "mrna42-none-none",
                "ped100-none-none", "snp100-none-none", "ped100-snp77-none",
                "ped100-mrna42-none", "snp100-mrna42-none",
                "ped100-snp77-mrna42")
```


Distribution of predicted and observed values.
Bear in mind that the distribution of the observed values will be different
for different predictors because some predictors "xx42" and "xx77", where
'xx' denotes a predictor, contain less hybrids than there are available 
(i.e. "xx100").
```{r Distribution-y-yhat, cache = TRUE, fig.height = 12, fig.cap = "Frequency polygon of observed and predicted values for seven agronomic traits (columns) and nine sets of predictors (rows)."}
legend_labs <- expression(y, hat(y))
pred_df %>%
  filter(Predictor != "snp77-none-none") %>%
  gather(key = Value, value = `Phenotypic Value`, y, yhat) %>%
  mutate(Predictor = fct_relevel(Predictor, pred_order)) %>%
  ggplot(aes(x = `Phenotypic Value`, color = Value)) +
  geom_freqpoly() +
  scale_color_manual(values = c("#1f78b4", "#e31a1c"), labels = legend_labs) +
  facet_grid(Predictor ~ Trait, scales = "free") +
  theme_bw() +
  theme(legend.position = "top",
        strip.text.y = element_text(size = 7)) +
  guides(color = guide_legend(override.aes = list(size = 2))) +
  ylab("Frequency")
```



Compare the coefficients of variation for all predictor-trait combinations.
```{r Coefficient-of-Variation-Plot, cache = TRUE, fig.cap = "Coefficient of variation for seven agronomic traits and nine sets of predictors."}
overview_df %>%
  filter(Predictor != "snp77-none-none") %>%
  mutate(Predictor = fct_relevel(Predictor, pred_order)) %>%
  ggplot(aes(x = CV, y = Predictor)) +
  geom_segment(aes(yend = Predictor), xend = 0, color = "gray50") +
  geom_point(aes(color = Predictor), size = 3) +
  scale_color_viridis(discrete = TRUE, option = "inferno") +
  facet_wrap(~ Trait, scales = "free_x") +
  theme_bw() +
  theme(panel.grid.major.y = element_blank(),
        axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        legend.position = c(0.7, 0.13)
  ) +
  guides(color = guide_legend(ncol = 2,
                              reverse = FALSE)) +
  xlab("Coefficient of Variation") +
  ylab("Predictor Set") +
  xlim(0, NA)
```

Plot the predictive abilities for all predictor-trait combinations 
separately for the reduced and the full data set, respectively.
```{r Predictive-Ability-Plots, cache = TRUE, fig.height = 10, fig.cap = "Predictive ability for seven agronomic traits (rows) and nine predictor sets (columns). The predictor sets are split into the categories 'Reduced' (i.e. 685 hybrids) and 'Full' (i.e. 1,521 hybrids)."}
overview_df %>%
  as_tibble() %>%
  filter(Predictor != "snp77-none-none") %>%
  mutate(Predictor = fct_relevel(Predictor, pred_order),
         Group = fct_relevel(Group, "Reduced", "Full")
  ) %>%
  ggplot(aes(x = Predictor, y = r)) +
  geom_bar(stat = "identity", aes(fill = Predictor), color = "black") +
  geom_text(aes(label = round(r, digits = 3)), vjust = -0.2) +
  scale_fill_viridis(discrete = TRUE, option = "inferno") +
  facet_grid(Trait ~ Group, space = "free", scales = "free_x") +
  theme_bw() +
  theme(
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    legend.position = "bottom",
    legend.key = element_rect(color = "white")
  ) +
  guides(fill = guide_legend(nrow = 3,
                             byrow = TRUE,
                             keywidth = 0.25,
                             keyheight = 0.25,
                             default.unit = "inch",
                             title.position = "top")
  ) +
  ylim(c(0, 1))
```

