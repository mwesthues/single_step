# Evaluation of LOOCV predictive abilities
```{r message = FALSE}
if (!require("pacman")) install.packages("pacman")
pacman::p_load("data.table", "ggplot2", "ggthemes", "dplyr", "forcats", 
               "viridis", "tidyr", "gridExtra", "modelr", "MASS")
knit_hooks$set(inline = function(x) {
  prettyNum(x, big.mark = ",", digits = 2)
})
knitr::opts_knit$set(root.dir = "~/gamazon/",
                     inline = TRUE)
knitr::opts_chunk$set(fig.width = 8, fig.height = 6, echo = FALSE, 
                      warning = FALSE, echo = FALSE)
```


### Predicted vs. residuals
Generate residual plots for each trait and each combination of missing values 
in Dent (rows) and Flint (columns) parents.
```{r Imputed-Residual, cache = TRUE, dependson = "Rename-Traits"}
resid_plots <- loocv_clean %>%
  filter(Predictor == "mRNA") %>%
  group_by(Trait) %>%
  do(plot = ggplot(., aes(x = yhat, y = Residuals)) +
            geom_point(size = 0.5) +
            geom_ref_line(h = 0) +
            facet_grid(Dent_NA_Fraction ~ Flint_NA_Fraction) +
            theme_light() +
            theme(axis.text.x = element_text(angle = 60, 
                                             hjust = 1, vjust = 1)) +
            xlab("Predicted") +
            ylab("Residuals") +
            ggtitle(.$Trait))
invisible(lapply(resid_plots$plot, print))
```


### Predicted vs. observed
Likewise, compare observed with predicted values for combinations that were used
in the previous plot.
```{r Imputed-y-yHat, cache = TRUE, dependson = "Rename-Traits"}
y_yhat_plots <- loocv_clean %>%
  filter(Predictor == "mRNA") %>%
  group_by(Trait) %>%
  do(plot = ggplot(., aes(x = y, y = yhat)) +
            geom_point(size = 0.5) +
            geom_abline(slope = 1, linetype = "dashed", color = "blue") +
            facet_grid(Dent_NA_Fraction ~ Flint_NA_Fraction) +
            theme(axis.text.x = element_text(angle = 60,
                                             hjust = 1, vjust = 1)) +
            xlab("Observed") +
            ylab("Predicted") +
            ggtitle(.$Trait))
invisible(lapply(y_yhat_plots$plot, print))
```



## LOOCV predictive ability (DMY)
### mrna
```{r DMY, cache = TRUE, dependson = "Rename-Traits"}
dmy <- loocv_clean %>%
  mutate(Dent_NA_Fraction = as.numeric(as.character(Dent_NA_Fraction)),
         Flint_NA_Fraction = as.numeric(as.character(Flint_NA_Fraction))) %>%
  filter(Trait == "DMY", Predictor == "mRNA") %>%
  droplevels() %>%
  unite(NA_Fraction, Dent_NA_Fraction, Flint_NA_Fraction, sep = "_") %>%
  group_by(Predictor, Trait, NA_Fraction) %>%
  summarize(Pred_Ability = cor(y, yhat)) %>%
  ungroup() %>%
  arrange(desc(Pred_Ability)) %>%
  separate(NA_Fraction,
           into = c("Dent_NA_Fraction", "Flint_NA_Fraction"), 
           sep = "_") %>%
  mutate(Dent_NA_Fraction = as.numeric(Dent_NA_Fraction),
         Flint_NA_Fraction = as.numeric(Flint_NA_Fraction)) %>%
  rowwise() %>%
  mutate(Avg_NA = mean(c(Dent_NA_Fraction, Flint_NA_Fraction)))
```

### Average r as a function of global missingness and missingness in Flint
```{r DMY_Global_NA_Flint_NA, cache = TRUE, dependson = "DMY"}
dmy %>%
  mutate(Flint_NA_Fraction = as.factor(as.character(Flint_NA_Fraction))) %>%
  mutate(Flint_NA_Fraction = fct_relevel(Flint_NA_Fraction, 
                                         "0", "0.1", "0.2", "0.3", "0.4",
                                         "0.5", "0.6")) %>%
  arrange(desc(Avg_NA)) %>%
  ggplot(aes(x = Avg_NA, y = Pred_Ability, color = Flint_NA_Fraction)) +
  geom_point(size = 2) +
  geom_line() +
  geom_smooth(method = "rlm", aes(group = 1)) +
  theme_light() +
  ylab("r")
```

### Average r as a function of missingness in Dent and missingness in Flint
```{r DMY_Dent_NA_Flint_NA, cache = TRUE, dependson = "DMY"}
dmy %>%
  mutate(Flint_NA_Fraction = as.factor(as.character(Flint_NA_Fraction))) %>%
  mutate(Flint_NA_Fraction = fct_relevel(Flint_NA_Fraction, 
                                         "0", "0.1", "0.2", "0.3", "0.4",
                                         "0.5", "0.6")) %>%
  arrange(desc(Dent_NA_Fraction)) %>%
  ggplot(aes(x = Dent_NA_Fraction, y = Pred_Ability, 
             color = Flint_NA_Fraction)) +
  geom_point(size = 2) +
  geom_line() +
  geom_smooth(method = "rlm", aes(group = 1)) +
  theme_light() +
  ylab("r")
```


### Predictive ability as a function of missingness in Dent and missingness in 
### Flint for all traits
```{r All_Traits_Dent_NA_Flint_NA, cache = TRUE, dependson = "Rename-Trait"} 
loocv_clean %>%
  filter(Dent_NA_Fraction != 0, Flint_NA_Fraction != 0) %>%
  unite(NA_Fraction, Dent_NA_Fraction, Flint_NA_Fraction, sep = "_") %>%
  group_by(Trait, NA_Fraction) %>%
  summarize(Pred_Ability = cor(y, yhat)) %>%
  ungroup() %>%
  separate(NA_Fraction, into = c("Dent_NA_Fraction",
                                 "Flint_NA_Fraction"), sep = "_") %>%
  mutate(Dent_NA_Fraction = as.numeric(Dent_NA_Fraction)) %>%
  ggplot(aes(x = Dent_NA_Fraction, y = Pred_Ability, 
             color = Flint_NA_Fraction)) +
  geom_line() +
  facet_wrap(~ Trait, scales = "free_x") +
  theme_light() +
  scale_color_viridis(discrete = TRUE) +
  theme(legend.position = "top") +
  ylab("r")
```
